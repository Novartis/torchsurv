
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Implementing time-varying covariates &#8212; TorchSurv  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/time_varying';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo_firecamp.png" class="logo__image only-light" alt="TorchSurv  documentation - Home"/>
    <img src="../_static/logo_firecamp.png" class="logo__image only-dark pst-js-only" alt="TorchSurv  documentation - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">API:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../loss.html">Loss</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/torchsurv.loss.cox.html">torchsurv.loss.cox</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/torchsurv.loss.momentum.html">torchsurv.loss.momentum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/torchsurv.loss.weibull.html">torchsurv.loss.weibull</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../metrics.html">Metrics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/torchsurv.metrics.auc.html">torchsurv.metrics.auc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/torchsurv.metrics.cindex.html">torchsurv.metrics.cindex</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/torchsurv.metrics.brier_score.html">torchsurv.metrics.brier_score</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../stats.html">Stats</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/torchsurv.stats.kaplan_meier.html">torchsurv.stats.kaplan_meier</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/torchsurv.stats.ipcw.html">torchsurv.stats.ipcw</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="survival.html">A statistical introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="momentum.html">Survival with MNIST</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Other:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOG.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AUTHORS.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devnotes.html">Development notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarks.html">Related packages</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/time_varying.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Implementing time-varying covariates</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Future-project-ideas:">Future project ideas:</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Partial-log-likelihood-for-time-varying-covariates">Partial log likelihood for time-varying covariates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Context-and-statistical-set-up">Context and statistical set-up</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Extension-to-neural-networks">Extension to neural networks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Dependencies">Dependencies</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Simulating-realistic-data">Simulating realistic data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Longitudinal-data-(covariates)">Longitudinal data (covariates)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Survival-data-(outcomes)">Survival data (outcomes)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Data-Format">Data Format</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Training-the-RNN">Training the RNN</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Comparison-to-Lifelines-package">Comparison to Lifelines package</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Real-life-data:-heart-transplant-survival">Real life data: heart transplant survival</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="Implementing-time-varying-covariates">
<h1>Implementing time-varying covariates<a class="headerlink" href="#Implementing-time-varying-covariates" title="Link to this heading">#</a></h1>
<p>In this notebook, we analyse a simulated dataset with time-varying covariates and survival outcomes. <code class="docutils literal notranslate"><span class="pre">TorchSurv</span></code> is used to train a model that predicts relative risk of subjects based on covariates observed over time. We will attempt to thoroughly explain the necessary elements to understand our implementation, but for a detailed read on time-varying survival models refer to Chapter 6 of <a class="reference external" href="https://link.springer.com/book/10.1007/0-387-33960-4">Dynamic Regression Models for Survival Data</a>. For
a more brief explanation, please refer to these <a class="reference external" href="https://ms.uky.edu/~mai/sta635/Cox%20model.pdf">slides</a>. Below is a summary of the necessary information.</p>
<section id="Future-project-ideas:">
<h2>Future project ideas:<a class="headerlink" href="#Future-project-ideas:" title="Link to this heading">#</a></h2>
<p>Future projects can take on various themes: testing edge cases of this implementation, improving the code to become more robust to different data types, include weibull distribution and compare this approate. Testing edge cases: - use the simulated data and change different parameters to see how it affects performance, this can help guide appropriate use - design slightly different simulations known for being difficult or easy in specific scenarios - use a dataset with known properties</p>
<p>Improving code to be more robust: - generalising the loss functions and overall defining the formatting required or it to work, generalise for different time scales etc. - extend the method to deal with multiple types of covariates in one loss function or a combination of multiple losses. This can extend to multiple time-varyin covariates and mixing time-invarint and varying ones.</p>
<p>Weibull: - Extent the cox loss function to also include the Weibull distribution, this is described for both the log-likelihood and the simulation</p>
<p>Comparison - One could compare this approach to other loss functions or statistical model to get an idea of what it brings as a benefit and a challenge. Note this comparison can be done via simulation or some dataset.</p>
<section id="Partial-log-likelihood-for-time-varying-covariates">
<h3>Partial log likelihood for time-varying covariates<a class="headerlink" href="#Partial-log-likelihood-for-time-varying-covariates" title="Link to this heading">#</a></h3>
</section>
</section>
<section id="Context-and-statistical-set-up">
<h2>Context and statistical set-up<a class="headerlink" href="#Context-and-statistical-set-up" title="Link to this heading">#</a></h2>
<p>Let <span class="math notranslate nohighlight">\(i\)</span> e the index for some subject <span class="math notranslate nohighlight">\(i\)</span> with a failute time denoted as <span class="math notranslate nohighlight">\(\tau^*_i\)</span> and <span class="math notranslate nohighlight">\(C\)</span> be the censoring time. For the moment <span class="math notranslate nohighlight">\(C\)</span> remains constant but there are extensions that allow for <span class="math notranslate nohighlight">\(C\)</span> to vary over <span class="math notranslate nohighlight">\(i\)</span>. Let <span class="math notranslate nohighlight">\(\tau_i = min(\tau^*_i, C)\)</span>. We use <span class="math notranslate nohighlight">\(\delta_i\)</span> to denote whether <span class="math notranslate nohighlight">\(\tau^*_i\)</span> was observed.</p>
<p>We will use <span class="math notranslate nohighlight">\(Z(t)\)</span> to denote the value of of covariate <span class="math notranslate nohighlight">\(Z\)</span> and time <span class="math notranslate nohighlight">\(t\)</span>. We use <span class="math notranslate nohighlight">\(Z(t)\)</span> to denote the value of Z at time <span class="math notranslate nohighlight">\(t\)</span> and <span class="math notranslate nohighlight">\(\overline{Z}(t)\)</span> to denote the set of covariates from the beginning up to time <span class="math notranslate nohighlight">\(t\)</span>: $ <span class="math">\overline{Z}`(t) = { Z(s): 0 :nbsphinx-math:</span>leq <cite>s :nbsphinx-math:</cite>leq <cite>t}$. Let :math:`t_k</cite> for $k <span class="math">\in `{1, :nbsphinx-math:</span>dots`, K} denote the time points at which the covariates are observed. For the
moment, we assume that all subjects have been observed on the same time grid. <span class="math notranslate nohighlight">\(R_k\)</span> is the set of individuals who are at risk at <span class="math notranslate nohighlight">\(t_k\)</span>.</p>
<p>The conditional hazard function of <span class="math notranslate nohighlight">\(T\)</span> given <span class="math notranslate nohighlight">\(\overline{Z}(t)\)</span> is defined as</p>
<div class="math notranslate nohighlight">
\[\lambda(T|\overline{Z}(t)) = Pr(T \in [t, t+ dt)|T \geq t, \overline{Z}(t)),\]</div>
<p>in other words, it is the probability that an event will occur in the next time instance if we have observed covariates up to time <span class="math notranslate nohighlight">\(t\)</span> and that a subject has not yet experienced an event.</p>
<p>The typical cox proportional hazards model with constant covariates <span class="math notranslate nohighlight">\(Z\)</span> assumes a constant hazard ratio: <span class="math notranslate nohighlight">\(\lambda(T|Z)= \lambda_0(t) exp(\beta Z)\)</span>, where <span class="math notranslate nohighlight">\(\beta\)</span> in an unknown set of regression parameters and <span class="math notranslate nohighlight">\(\lambda_0(t)\)</span> is an unspecified baseline hazard function. In this case $:nbsphinx-math:<cite>frac{lambda(T|Z)}{lambda_0(t)}</cite> = exp(<span class="math">\beta `Z) $. The cumulative hazard ia defined as :math:</span>Lambda(t) = int_0^t lambda(s)ds`.</p>
<p>In a time varying cox model, the hazard ratio is now dependent on time:</p>
<div class="math notranslate nohighlight">
\[\frac{\lambda(t|Z)}{\lambda_0(t)} = exp(\beta Z(t))\]</div>
<p>and the proportional hazard model specifies:</p>
<div class="math notranslate nohighlight">
\[\lambda(t|Z) = \lambda_0(t)exp(\beta Z(t))\]</div>
<p>Let <span class="math notranslate nohighlight">\(i_j\)</span> denote the label or identity of the individual who fails at time <span class="math notranslate nohighlight">\(\tau_j\)</span>, including the value of their time-varying covariate during their time in the study <span class="math notranslate nohighlight">\(\{ Z_{i_j}(t): t \in [0, \tau_j] \}\)</span>. The partial likelihood is:</p>
<div class="math notranslate nohighlight">
\[L (\beta) = \prod_j \Big (\frac{\lambda(\tau_j: Z_i(\tau_j)))}{\sum_{l \in R_i} \lambda(\tau_j: Z_l(\tau_j)))} \Big),\]</div>
<p>in terms of the model form:</p>
<div class="math notranslate nohighlight">
\[L (\beta) = \prod_j \Big (\frac{\exp(\beta Z_i(\tau_j))}{\sum_{j \in R_i} \exp(\beta Z_i(\tau_j))} \Big).\]</div>
<p>Taking the log on both sides, we get the partial log-likelihood:</p>
<div class="math notranslate nohighlight">
\[\log L (\beta) = \sum_j \Big (\beta Z_i(\tau_j)) - \log [\sum_{j \in R_i} \exp(\beta Z_i(\tau_j))]\Big ).\]</div>
</section>
<section id="Extension-to-neural-networks">
<h2>Extension to neural networks<a class="headerlink" href="#Extension-to-neural-networks" title="Link to this heading">#</a></h2>
<p>Consider a more genera form, where we have the cox proportional hazards model:</p>
<div class="math notranslate nohighlight">
\[\lambda(T|\overline{Z}(t))= \lambda_0(t) \theta(Z(t))\]</div>
<p>Additionally, consider some network that maps the input covariates <span class="math notranslate nohighlight">\(Z(t)\)</span> to the log relative hazards: <span class="math notranslate nohighlight">\(\log \theta(Z(t))\)</span>.</p>
<p>The partial likelihood with respect to <span class="math notranslate nohighlight">\(\theta(Z(\tau_j))\)</span> is written as:</p>
<div class="math notranslate nohighlight">
\[\log L(\theta) = \sum_j \Big( \log \theta(Z_i(\tau_j)) - \log [\sum_{j \in R_i} \theta (Z_i(\tau_j))] \Big).\]</div>
<p>It onlu considers the covariate values at the time of event or censoring denoted as <span class="math notranslate nohighlight">\(\tau_j\)</span>, all prior covariates are not considered.</p>
<p>As the output of the network is set to be <span class="math notranslate nohighlight">\(\log \theta(Z(t))\)</span>, the code is written to account for this, to show this explicitly, set <span class="math notranslate nohighlight">\(\phi(Z(t)) = \log \theta(Z(t))\)</span> and write the log likelihood in terms oh <span class="math notranslate nohighlight">\(phi\)</span>:</p>
<div class="math notranslate nohighlight">
\[\log L(\theta) = \sum_j \Big( \phi(Z_i(\tau_j)) - \log [\sum_{j \in R_i} \exp \phi(Z_i(\tau_j))] \Big).\]</div>
</section>
<section id="Dependencies">
<h2>Dependencies<a class="headerlink" href="#Dependencies" title="Link to this heading">#</a></h2>
<p>To run this notebook, dependencies must be installed. the recommended method is to use our development conda environment (<strong>preferred</strong>). Instruction can be found <a class="reference external" href="https://opensource.nibr.com/torchsurv/devnotes.html#set-up-a-development-environment-via-conda">here</a> to install all optional dependencies. The other method is to install only required packages using the command line below:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install only required packages (optional)</span>
<span class="c1"># %pip install lifelines</span>
<span class="c1"># %pip install matplotlib</span>
<span class="c1"># %pip install sklearn</span>
<span class="c1"># %pip install pandas</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="c1"># Our package</span>
<span class="c1"># from torchsurv.loss.time_varying import neg_partial_log_likelihood2</span>
<span class="c1"># PyTorch boilerplate - see https://github.com/Novartis/torchsurv/blob/main/docs/notebooks/helpers_introduction.py</span>
</pre></div>
</div>
</div>
<section id="Simulating-realistic-data">
<h3>Simulating realistic data<a class="headerlink" href="#Simulating-realistic-data" title="Link to this heading">#</a></h3>
<p>A good approach for simulating data is described in detail by <a class="reference external" href="https://pmc.ncbi.nlm.nih.gov/articles/PMC7731987/">Ngwa et al 2020</a>. If this is not yet implemented, it would be a good way of starting to ensure that both methods work as expected. There are tow parts in simulating such a dataset. First, simulating the longitudina lobservational data and then the survival data. Below we describe methodologies for both.</p>
</section>
</section>
<section id="Longitudinal-data-(covariates)">
<h2>Longitudinal data (covariates)<a class="headerlink" href="#Longitudinal-data-(covariates)" title="Link to this heading">#</a></h2>
<p>We use <span class="math notranslate nohighlight">\(i \in \{1, \dots, n\}\)</span> to index subjects and <span class="math notranslate nohighlight">\(j \in \{1, \dots, m_i\}\)</span> to index time points where <span class="math notranslate nohighlight">\(m_i\)</span> is the final time point for subject <span class="math notranslate nohighlight">\(i\)</span>. We simulate covariates independently: - age at baseline <span class="math notranslate nohighlight">\(Age_i \sim N(35,5)\)</span> - sex <span class="math notranslate nohighlight">\(\sim Bernoulli(p=0.54)\)</span></p>
<p>Generate expected longitudinal trajectories <span class="math notranslate nohighlight">\(\varphi_{\beta}(t_{ij})\)</span>:</p>
<div class="math notranslate nohighlight">
\[\varphi_{\beta}(t_{ij}) = b_{i1} + b_{i2} \cdot t_{ij} + \alpha Age_i,\]</div>
<p>where <span class="math notranslate nohighlight">\(b_{i1}, b_{i2}\)</span> are random effects</p>
<p>We will generate <span class="math notranslate nohighlight">\(b_{i1}, b_{i2}\)</span> from multivariate normal distribution with a covariance matrix <span class="math notranslate nohighlight">\(G = [[0.29, -0.00465],[-0.00465, 0.000320]]\)</span>. Sample from this multivariate normal distribution (with mean zero) to get the random intercept and slope.</p>
<p>The observed longitudinal measures measures <span class="math notranslate nohighlight">\(Y_{ij}(t_{ij})\)</span> from a multivariate normal distribution with mean $ <span class="math">\varphi</span><em>{:nbsphinx-math:`beta`}(t</em>{ij})$ and variance <span class="math notranslate nohighlight">\(V\)</span>:</p>
<div class="math notranslate nohighlight">
\[V = Z_i GZ_i ^T + R_i, \text{ where }Z_i = [[1,1,1,1,1,1]^T, [0,5,10,15,20,25]^T]\]</div>
<p>and <span class="math notranslate nohighlight">\(R_i = diag(\sigma^2)\)</span> and <span class="math notranslate nohighlight">\(\sigma^2\)</span> is set to <span class="math notranslate nohighlight">\(0.1161\)</span>.</p>
<p>Note: Compared to the paper, we slightly adjust steps 3 and 4 from the simulation algorithm section (6.1) to avoid fitting a random effects model which adds more complexity in terms of data formatting.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.distributions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dist</span>

<span class="c1"># Set random seed for reproducibility</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Number of subjects</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>  <span class="c1"># Number of time points</span>
<span class="n">time_vec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

<span class="c1"># Simulation parameters</span>
<span class="n">age_mean</span> <span class="o">=</span> <span class="mi">35</span>
<span class="n">age_std</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">sex_prob</span> <span class="o">=</span> <span class="mf">0.54</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">0.29</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00465</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.00465</span><span class="p">,</span> <span class="mf">0.000320</span><span class="p">]])</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">time_vec</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1161</span><span class="p">])</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Simulate age at baseline</span>
<span class="n">age_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">age_mean</span><span class="p">,</span> <span class="n">age_std</span><span class="p">)</span>
<span class="n">age</span> <span class="o">=</span> <span class="n">age_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span>

<span class="c1"># Simulate sex</span>
<span class="n">sex_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">sex_prob</span><span class="p">)</span>
<span class="n">sex</span> <span class="o">=</span> <span class="n">sex_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span>

<span class="c1"># Simulate random effects</span>
<span class="n">random_effects_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">G</span><span class="p">)</span>
<span class="n">random_effects</span> <span class="o">=</span> <span class="n">random_effects_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span>

<span class="c1"># sample random error</span>
<span class="n">error_sample</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span>

<span class="c1"># Generate expected longitudinal trajectories</span>
<span class="c1"># quite frakly this is useless now - it was based on my bad understanding of the algorithm</span>
<span class="n">trajectories</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">random_effects</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">random_effects</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Z</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">age</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">error_sample</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">trajectories</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[34.2016, 34.2186, 34.2356, 34.2526, 34.2696, 34.2866],
        [33.4380, 33.4308, 33.4235, 33.4163, 33.4091, 33.4018],
        [31.5581, 31.5564, 31.5548, 31.5531, 31.5515, 31.5498],
        [35.7813, 35.7953, 35.8093, 35.8233, 35.8373, 35.8513]])
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## ANOTHER WAY OF GENERATING DATA</span>

<span class="c1"># # Simulate observed longitudinal measures</span>
<span class="c1"># R = torch.diag_embed(sigma.repeat(T))</span>
<span class="c1"># V = torch.matmul(torch.matmul(Z, G), Z.T) + R</span>

<span class="c1"># #get a mean trajectory</span>
<span class="c1"># b1 = torch.tensor([4.250])</span>
<span class="c1"># b2 = torch.tensor([0.250])</span>
<span class="c1"># mean_trajectory =  b1.item() + b2.item() * Z[:,1] + alpha * age_mean</span>

<span class="c1"># #define the distribution to sample the trajectories from</span>
<span class="c1"># observed_data_dist = dist.MultivariateNormal(trajectories, V)</span>

<span class="c1"># #sample from the distribution to get an n x T matrix of observations/covariates</span>
<span class="c1"># observed_data = observed_data_dist.sample((1,)).squeeze()</span>

<span class="c1"># print(observed_data[1:5, :])</span>
</pre></div>
</div>
</div>
</section>
<section id="Survival-data-(outcomes)">
<h2>Survival data (outcomes)<a class="headerlink" href="#Survival-data-(outcomes)" title="Link to this heading">#</a></h2>
<p>here I will describe how to get the survival and censoring for all the subjects from above. then I will code it up in python.</p>
<p>Specify (varying) values for the parameter estimates for <span class="math notranslate nohighlight">\(Age\)</span>, <span class="math notranslate nohighlight">\(sex\)</span> and the link parameter <span class="math notranslate nohighlight">\(\gamma\)</span>, which measures the strength of the association between the longitudinal measures <span class="math notranslate nohighlight">\(Y_{ij}(t_{ij})\)</span> and the time-to-event <span class="math notranslate nohighlight">\(\tau_j\)</span>.</p>
<p>Let <span class="math notranslate nohighlight">\(Q \sim Unif(0,1)\)</span> be a random variable that determines the hazard of a subject. Then using the time varying cox model it can be expressd as:</p>
<div class="math notranslate nohighlight">
\[Q(t;X,Y) = \exp[-H_0(t)\cdot \exp(X^T\alpha + \gamma (b_{i1} + b_{i2} \cdot t))],\]</div>
<p><span class="math notranslate nohighlight">\(X^T\)</span> is a vector of tine-invariant covariates, <span class="math notranslate nohighlight">\(\alpha\)</span> a vector of regression coefficients.</p>
<p><span class="math notranslate nohighlight">\(H_o(t) = \lambda t\)</span> and if <span class="math notranslate nohighlight">\(h_0(t)&gt;0\)</span> for all <span class="math notranslate nohighlight">\(t\)</span>, then <span class="math notranslate nohighlight">\(H_0\)</span> can be inverted:</p>
<div class="math notranslate nohighlight">
\[-\log(Q) = \lambda t \cdot \exp[X^T \alpha + \gamma (b_{i1} + b_{i2} \cdot t) ]\]</div>
<p>This expression can be rearranged to generate the times-to-event.</p>
<p>Generate the time-to-event <span class="math notranslate nohighlight">\(\tau_j\)</span> using the following equations for the Cox Exponential model:</p>
<div class="math notranslate nohighlight">
\[t = \frac{1}{\gamma \cdot b_{i2}} W \Big( \frac{-\gamma(b_{i2}) \log(Q)}{\lambda \exp (X^T \alpha + \gamma(b_{i1}))} \Big).\]</div>
<p>Where <span class="math notranslate nohighlight">\(W\)</span> is the Lambert W function (LWF) first proposed by <a class="reference external" href="https://link.springer.com/article/10.1007/BF02124750">Corless et al. 1996</a> provide a history, theory and applications of the LWF. The LWF is the inverse of the function $f(p) = p <span class="math">\cdot `:nbsphinx-math:</span>exp`(p) $.</p>
<p>Generate the censoring variable <span class="math notranslate nohighlight">\(C \sim Unif⁡(25, 30)\)</span> for censoring to occur later in study. From the survival and censoring times, we obtain the censoring indicator <span class="math notranslate nohighlight">\(\delta_i\)</span> which is defined as 1 if <span class="math notranslate nohighlight">\(\tau_j &lt; C_i\)</span> and 0 otherwise.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import lmbert W function</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">lambertw</span>
</pre></div>
</div>
</div>
<p>Note: pre-determined parameters such as <span class="math notranslate nohighlight">\(\alpha, \gamma, \lambda_0\)</span> have a large effect on the event time outcomes, the values used here are: - <span class="math notranslate nohighlight">\(\alpha_{age} = 0.05\)</span>, - <span class="math notranslate nohighlight">\(\alpha_{sex} = -0.1\)</span>, - <span class="math notranslate nohighlight">\(\gamma = 1.2\)</span>, - <span class="math notranslate nohighlight">\(\lambda_0 = 0.04\)</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify the values for parameters, generate the random variables and call on relevant variables defined previously</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">])</span>  <span class="c1"># regression coefficient for time-invariant covariates</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.2</span><span class="p">)</span>  <span class="c1"># association strength between longitudinal measures and time-to-event</span>
<span class="n">lambda_0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.04</span><span class="p">)</span>  <span class="c1"># baseline hazard rate</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="c1"># Generate the random variables for hazard of a subject and censoring</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span>  <span class="c1"># Random variable for hazard (Q)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span>  <span class="c1"># Random variable for censoring</span>

<span class="c1"># age and sex are the names of variables corresponding to those covariates</span>
<span class="c1"># create the X matrix of covariates</span>
<span class="n">XX</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">age</span><span class="p">,</span> <span class="n">sex</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># get b1 and b2 from the random sample we made before</span>
<span class="n">b1</span> <span class="o">=</span> <span class="n">random_effects</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">b2</span> <span class="o">=</span> <span class="n">random_effects</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Generate time to event T using the equation above</span>
<span class="n">log_Q</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">lambert_W_nominator</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">*</span> <span class="n">log_Q</span>
<span class="n">lambert_W_denominator</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">alpha</span> <span class="o">@</span> <span class="n">XX</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">b1</span><span class="p">)</span>
<span class="c1"># below should give a vector of length sample_size</span>
<span class="n">lambert_W</span> <span class="o">=</span> <span class="n">lambertw</span><span class="p">(</span><span class="o">-</span><span class="n">lambert_W_nominator</span> <span class="o">/</span> <span class="p">(</span><span class="n">lambda_0</span> <span class="o">*</span> <span class="n">lambert_W_denominator</span><span class="p">))</span>
<span class="n">time_to_event</span> <span class="o">=</span> <span class="n">lambert_W</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">b2</span><span class="p">)</span>

<span class="c1"># take the real part of the LBF, the complex part is =0</span>
<span class="n">outcome_LWF</span> <span class="o">=</span> <span class="n">time_to_event</span><span class="o">.</span><span class="n">real</span>
<span class="n">outcome_LWF</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">outcome_LWF</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">outcome_LWF</span><span class="p">)</span>

<span class="c1"># implement censoring with some level of intensity below</span>
<span class="n">events</span> <span class="o">=</span> <span class="n">C</span> <span class="o">&lt;</span> <span class="mi">5</span>
<span class="n">events</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([ 4.,  3.,  8.,  5., 22.,  1., 12.,  7.,  7.,  2.,  3.,  3., 12.,  3.,
        10.,  4., 17.,  1.,  3.,  2.,  1.,  3.,  1.,  1., 12.,  5.,  9.,  1.,
         2.,  8.,  1.,  2.,  1.,  1.,  1.,  7.,  7., 13., 11.,  3.,  6., 10.,
         5.,  1.,  3.,  3.,  3.,  4.,  1.,  1.,  3.,  2.,  2.,  2.,  5., 38.,
         4.,  1.,  5.,  9.,  3.,  1., 19.,  4.,  5.,  4.,  4., 16., 15.,  1.,
         1.,  2.,  4.,  9.,  2.,  3.,  6., 19.,  7.,  1.,  1.,  4.,  6.,  3.,
         8.,  6.,  8.,  2.,  1.,  2., 32.,  1.,  2.,  1., 13.,  2.,  1.,  2.,
         1.,  3.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([False,  True,  True,  True,  True,  True,  True, False,  True,  True,
        False,  True,  True,  True,  True,  True,  True,  True,  True, False,
         True,  True, False,  True, False,  True,  True,  True,  True, False,
         True,  True,  True,  True,  True,  True,  True,  True,  True,  True,
         True,  True,  True, False,  True,  True,  True,  True,  True,  True,
         True,  True,  True, False,  True, False,  True,  True,  True,  True,
         True, False,  True, False, False, False,  True, False, False, False,
         True,  True,  True,  True,  True,  True,  True,  True, False,  True,
         True,  True, False,  True,  True,  True,  True,  True, False,  True,
         True,  True,  True, False,  True,  True,  True,  True, False,  True])
</pre></div></div>
</div>
<p>A simpler method for generating the time-to-event where the covariate is assumed to have a more straightforward relation in time <span class="math notranslate nohighlight">\(Z(t) = kt\)</span> for some <span class="math notranslate nohighlight">\(k&gt;0\)</span>. This approach is suggested by <a class="reference external" href="https://pmc.ncbi.nlm.nih.gov/articles/PMC3546387/pdf/sim0031-3946.pdf">Peter C. Austin 2012</a> and here</p>
<div class="math notranslate nohighlight">
\[t = \frac{1}{\gamma k} \log \Big ( 1 + \frac{\gamma k (-log(u))}{\lambda \exp(\alpha X)}\Big).\]</div>
<p>The above equation has been adapted to remain consistent with the parameters defined before. In our case, <span class="math notranslate nohighlight">\(k\)</span> could be replaced with <span class="math notranslate nohighlight">\(b_{i2}\)</span> if <span class="math notranslate nohighlight">\(b_{i2}\)</span> would be sampled such that it is strictly positive. In the above configuration that is not the case.</p>
</section>
<section id="Data-Format">
<h2>Data Format<a class="headerlink" href="#Data-Format" title="Link to this heading">#</a></h2>
<p>Here we create a single matrix of data that corresponds to one covariate being observed over time for some dataset. The time series is padded with zeros so that each subject has the same length vector, the vector contains their covariate <span class="math notranslate nohighlight">\(Z_i(t)\)</span> up until failure time <span class="math notranslate nohighlight">\(\tau_j\)</span> and then values beyond that are zero.</p>
<p>In general, prior to fitting a survival model or a network, one should consider ohw to handle missing data beforehand. This is most important for covariates that are missing at event time $:nbsphinx-math:<cite>tau</cite>_j $. Data imputation methods can vary depending on the use case but some to consider are: - use the most recent value (assumes step function), - interpolate, - impute based on some model.</p>
<section id="Training-the-RNN">
<h3>Training the RNN<a class="headerlink" href="#Training-the-RNN" title="Link to this heading">#</a></h3>
<p>Below we will give an example set up of how to use the partial log likelihood in a loss function. We import the python file containing the loss and set up an RNN to work with our simulated data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">reload</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">loss_time_covariates</span>

<span class="n">reload</span><span class="p">(</span><span class="n">loss_time_covariates</span><span class="p">)</span>
<span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">loss_time_covariates</span><span class="o">.</span><span class="n">_partial_likelihood_time_cox</span>
<span class="n">neg_loss_function</span> <span class="o">=</span> <span class="n">loss_time_covariates</span><span class="o">.</span><span class="n">neg_partial_time_log_likelihood</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from torchsurv.loss import time_covariates</span>
<span class="c1"># from torchsurv.metrics.cindex import ConcordanceIndex</span>

<span class="c1"># Parameters</span>
<span class="n">input_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">output_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">num_layers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">seq_length</span> <span class="o">=</span> <span class="n">T</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="n">n</span>

<span class="c1"># Create simple RNN model</span>
<span class="n">rnn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">RNN</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">)</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">seq_length</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">trajectories</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># initialize hidden state</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_layers</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># Forward pass time series input</span>
<span class="n">outputs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rnn</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">h0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># outcome_LWF is the time someone experiences an event</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">neg_loss_function</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">outcome_LWF</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loss = </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">, has gradient = </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">requires_grad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># loss = 1.0389232635498047, has gradient = True</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
torch.Size([6, 100, 1])
torch.Size([6, 100, 1])
torch.Size([2, 100, 1])
torch.Size([6, 100, 1])
loss = 1.0968555212020874, has gradient = True
</pre></div></div>
</div>
</section>
<section id="Comparison-to-Lifelines-package">
<h3>Comparison to Lifelines package<a class="headerlink" href="#Comparison-to-Lifelines-package" title="Link to this heading">#</a></h3>
<p>Re-format the simulation data to fit a normal time-varying cox model in the lifelines package.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="nb">sum</span> <span class="k">as</span> <span class="n">array_sum_to_scalar</span>

<span class="c1"># as a reminder covars is the matrix of covariates where a row corresponds to a subject and a column corresponds to their observation at some time</span>
<span class="c1"># the columns are padded so if a subject experiences an event, the remaining of the column is zero</span>
<span class="c1"># Generating example torch matrix</span>
<span class="n">torch_matrix</span> <span class="o">=</span> <span class="n">trajectories</span>
<span class="c1"># Convert torch matrix to pandas dataframe</span>
<span class="c1"># set time to integer</span>
<span class="n">max_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">time_vec</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">max_time</span><span class="p">)</span>
<span class="n">event_time</span> <span class="o">=</span> <span class="n">outcome_LWF</span>
<span class="nb">vars</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">start</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">stop</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">event</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">subjs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">subj_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">subj_event_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="c1"># print(subj_event_time)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">subj_event_time</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_time</span><span class="p">:</span>
            <span class="nb">vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">stop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">subjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">subj_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">max_time</span><span class="p">:</span>
            <span class="nb">vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">stop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subj_event_time</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">subjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">subj_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">break</span>
    <span class="c1"># set the last value to have an event</span>
    <span class="n">event</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># if you want censoring use below</span>
    <span class="c1"># if events[i]==True: event[-1]=True</span>

<span class="c1"># for every time point before they experience an event</span>
<span class="c1"># record all their variables until event time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;subj&quot;</span><span class="p">:</span> <span class="n">subjs</span><span class="p">,</span>
        <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
        <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span>
        <span class="s2">&quot;events&quot;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
        <span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="nb">vars</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor(5)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>subj</th>
      <th>start</th>
      <th>stop</th>
      <th>events</th>
      <th>var</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>False</td>
      <td>37.006706</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>False</td>
      <td>37.013870</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>2</td>
      <td>3</td>
      <td>False</td>
      <td>37.021034</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>3</td>
      <td>4</td>
      <td>True</td>
      <td>37.028198</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>False</td>
      <td>34.201637</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>False</td>
      <td>34.218636</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>True</td>
      <td>34.235634</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>False</td>
      <td>33.438019</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>False</td>
      <td>33.430782</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2</td>
      <td>2</td>
      <td>3</td>
      <td>False</td>
      <td>33.423550</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We will compute the lgo likelihood using the code from lifelines to compare our method to theirs. This snippet of code is taken from <a class="reference external" href="https://github.com/CamDavidsonPilon/lifelines/blob/master/lifelines/fitters/cox_time_varying_fitter.py">cox_time_varying_fitter.py</a> on lines 499-550.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stop_times</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span>
<span class="n">event_bool</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
<span class="n">unique_death_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">stop_times</span><span class="p">[</span><span class="n">event_bool</span><span class="p">])</span>
<span class="n">covariates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;var&quot;</span><span class="p">]</span>
<span class="c1"># the following is an internal column in lifelines, since we do not define it in this simulation it is set to 1.0</span>
<span class="c1"># this is also done in the code at lines 182-185</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>


<span class="c1"># below is defined at line 50, unsure what this means</span>
<span class="k">def</span><span class="w"> </span><span class="nf">matrix_axis_0_sum_to_1d_array</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="c1"># we will be replacing x*beta from the code with out outputs from the network as written in the beginning of this notebook</span>
<span class="c1"># network_out = outputs</span>
<span class="c1"># print(network_out.shape)</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="p">)</span>
<span class="c1"># print(beta)</span>
<span class="c1"># print(beta.shape)</span>
<span class="c1"># np.dot(X_at_t, beta)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">unique_death_times</span><span class="p">:</span>
    <span class="c1"># returns a boolean vector of length nxT in our case</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="p">)</span>
    <span class="c1"># returns a vector of covariates at event time</span>
    <span class="n">X_at_t</span> <span class="o">=</span> <span class="n">covariates</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
    <span class="n">weights_at_t</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
    <span class="n">stops_events_at_t</span> <span class="o">=</span> <span class="n">stop_times</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
    <span class="n">events_at_t</span> <span class="o">=</span> <span class="n">event_bool</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>

    <span class="c1"># changed dot product to multiply cause dot is no longer supported in that way</span>
    <span class="n">phi_i</span> <span class="o">=</span> <span class="n">weights_at_t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">X_at_t</span><span class="p">,</span> <span class="n">beta</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">phi_i</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># removed indexing from original code cause we only have 1 dim</span>
    <span class="n">phi_x_i</span> <span class="o">=</span> <span class="n">phi_i</span> <span class="o">*</span> <span class="n">X_at_t</span>
    <span class="n">phi_x_x_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X_at_t</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">phi_x_i</span><span class="p">)</span>

    <span class="c1"># Calculate sums of Risk set</span>
    <span class="n">risk_phi</span> <span class="o">=</span> <span class="n">array_sum_to_scalar</span><span class="p">(</span><span class="n">phi_i</span><span class="p">)</span>
    <span class="n">risk_phi_x</span> <span class="o">=</span> <span class="n">matrix_axis_0_sum_to_1d_array</span><span class="p">(</span><span class="n">phi_x_i</span><span class="p">)</span>
    <span class="n">risk_phi_x_x</span> <span class="o">=</span> <span class="n">phi_x_x_i</span>

    <span class="c1"># Calculate the sums of Tie set</span>
    <span class="n">deaths</span> <span class="o">=</span> <span class="n">events_at_t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stops_events_at_t</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">tied_death_counts</span> <span class="o">=</span> <span class="n">array_sum_to_scalar</span><span class="p">(</span><span class="n">deaths</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>  <span class="c1"># should always at least 1. Why? TODO</span>

    <span class="n">xi_deaths</span> <span class="o">=</span> <span class="n">X_at_t</span><span class="p">[</span><span class="n">deaths</span><span class="p">]</span>

    <span class="n">x_death_sum</span> <span class="o">=</span> <span class="n">matrix_axis_0_sum_to_1d_array</span><span class="p">(</span><span class="n">weights_at_t</span><span class="p">[</span><span class="n">deaths</span><span class="p">]</span> <span class="o">*</span> <span class="n">xi_deaths</span><span class="p">)</span>

    <span class="n">weight_count</span> <span class="o">=</span> <span class="n">array_sum_to_scalar</span><span class="p">(</span><span class="n">weights_at_t</span><span class="p">[</span><span class="n">deaths</span><span class="p">])</span>
    <span class="n">weighted_average</span> <span class="o">=</span> <span class="n">weight_count</span> <span class="o">/</span> <span class="n">tied_death_counts</span>

    <span class="c1"># no tensors here, but do some casting to make it easier in the converging step next.</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">risk_phi</span><span class="p">])</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">risk_phi_x</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">risk_phi_x_x</span> <span class="o">*</span> <span class="n">denom</span>

<span class="n">summand</span> <span class="o">=</span> <span class="n">number</span> <span class="o">*</span> <span class="n">denom</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">a2</span> <span class="o">=</span> <span class="n">summand</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">summand</span><span class="p">)</span>
<span class="n">log_lik</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x_death_sum</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="n">weighted_average</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">denom</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">log_lik</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(100,)
(76,)
(62,)
(47,)
(38,)
(32,)
(28,)
(23,)
(19,)
(16,)
(14,)
(13,)
(10,)
(8,)
(7,)
(6,)
(5,)
(3,)
(2,)
(1,)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([0.])
</pre></div></div>
</div>
<p>Fitting a cox regression model using the lifelines package.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">lifelines</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoxTimeVaryingFitter</span>

<span class="n">ctv</span> <span class="o">=</span> <span class="n">CoxTimeVaryingFitter</span><span class="p">(</span><span class="n">penalizer</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ctv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s2">&quot;subj&quot;</span><span class="p">,</span> <span class="n">event_col</span><span class="o">=</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="n">start_col</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">stop_col</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ctv</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">ctv</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Real-life-data:-heart-transplant-survival">
<h3>Real life data: heart transplant survival<a class="headerlink" href="#Real-life-data:-heart-transplant-survival" title="Link to this heading">#</a></h3>
<p>This is to demonstrate the method with a neural network, example inspired by the <a class="reference external" href="https://lifelines.readthedocs.io/en/latest/Time%20varying%20survival%20regression.html#">lifelines example</a>.</p>
<p>This is a classic dataset for survival regression with time varying covariates. The original dataset is from J Crowley and M Hu. ‘Covariance analysis of heart transplant survival data’, and this dataset is from R’s survival library.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lifelines</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">load_stanford_heart_transplants</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The dataset contains the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">start</span></code>: entry time,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stop</span></code>: exit time,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">event</span></code>: status for this interval of time,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">age</span></code>: subjetct’s age -48 years,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">year</span></code>: tyear of acceptance (in years after 1 Nov 1967)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">surgery</span></code>: prior bypass surgery 1=yes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">transplant</span></code>: received transplant 1=yes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code>: patient id</p></li>
</ul>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Future-project-ideas:">Future project ideas:</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Partial-log-likelihood-for-time-varying-covariates">Partial log likelihood for time-varying covariates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Context-and-statistical-set-up">Context and statistical set-up</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Extension-to-neural-networks">Extension to neural networks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Dependencies">Dependencies</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Simulating-realistic-data">Simulating realistic data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Longitudinal-data-(covariates)">Longitudinal data (covariates)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Survival-data-(outcomes)">Survival data (outcomes)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Data-Format">Data Format</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Training-the-RNN">Training the RNN</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Comparison-to-Lifelines-package">Comparison to Lifelines package</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Real-life-data:-heart-transplant-survival">Real life data: heart transplant survival</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Thibaud Coroller, Mélodie Monod, Peter Krusche, Qian Cao
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, Novartis Pharma AG.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>